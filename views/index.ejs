<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>

<section class="articles container my-4">
  <div class="d-flex justify-content-between align-items-center mb-4 ms-2">
  <h2 class="articles__heading mb-0">Latest Posts</h2>
  
  <div class="d-flex align-items-center">
    <% if (user) { %>
      <% if (!user.hasProAccess) { %>
        <a href="/checkout" class=" btn-success me-2 text-decoration-none">ðŸ’³ Pro Access</a>
      <% } %>
      <span class="badge <%= user.hasProAccess ? 'bg-success' : '' %>">
                  <%= user.hasProAccess ? 'â­Pro  ' : '' %>
      </span>
      <a href="/logout" class=" btn-danger"
         onclick="return confirm('âš ï¸ Are you sure you want to log out?');">
         <img src="/icons8-power-button-64.png" alt="logout">
      </a>
    <% } else { %>
      <a href="/login" class="btn-outline-secondary">
        <img src="/log-in.png" alt="login" title="login"> Login
      </a>
    <% } %>
  </div>
</div>
<div class="row g-4">
  <% 
    const defaultImage = "/image.png";
    const maxCards = 6;
    const normalPosts = data.filter(post => !post.isProBlog);
    const proPosts = data.filter(post => post.isProBlog);
    let displayPosts = [];
    if(user && user.hasProAccess){
      displayPosts = [...normalPosts, ...proPosts].slice(0, maxCards);
    } else {
      displayPosts = normalPosts.slice(0, maxCards - 1);
    }
    const totalCards = maxCards;
  %>
  <% for(let i=0; i<totalCards; i++){ %>
    <div class="col-lg-4 col-md-6 col-sm-12">
      <% if(displayPosts[i]) { 
            const post = displayPosts[i];
            const imgSrc = post.image ? (Array.isArray(post.image) ? post.image[0] : post.image) : defaultImage;
      %>
        <div class="card h-100 shadow-sm blog-card">
          <img src="<%= imgSrc %>" alt="Blog image" class="card-img-top mb-2"
               style="max-height:180px; object-fit:cover;"
               onerror="this.onerror=null;this.src='<%= defaultImage %>';">
          <div class="card-body d-flex flex-column">
            <h5 class="card-title fw-semibold"><%= post.title %></h5>
            <% let textOnly = post.body.replace(/<[^>]*>/g,"");
               let excerpt = textOnly.split(" ").slice(0,30).join(" "); %>
            <p class="card-text"><%- excerpt %></p>
            <p class="card-text text-muted mt-auto mb-2">
              <small><%= post.createdAt.toDateString() %></small>
            </p>
            <a href="/post/<%= post._id %>" class="stretched-link"></a>
          </div>
        </div>
      <% } else if(i === totalCards - 1 && (!user || (user && !user.hasProAccess))) { %>

        <div class="card h-100 shadow-sm blog-card position-relative locked-card"onclick="<% if(!user){ %> window.location='/login'; <% } else { %> window.location='/checkout'; <% } %>">
          <div style="height:180px; background:#ccc; filter:blur(4px);"></div>
          <div class="overlay d-flex flex-column justify-content-center align-items-center text-center">
            <i class="fas fa-lock fa-2x mb-2 text-white"></i>
            <h5 class="text-white fw-bold">Pro Blog</h5>
            <p class="text-white">Upgrade to Pro to view</p>
          </div>
        </div>
      <% } %>
    </div>
  <% } %>
</div>

<div class="pagination-wrapper">
  <% if (totalPages > 1) { %>
    <%- include("partials/pagination", {
      current: current,
      totalPages: totalPages,
      pages: pages,
      searchTerm: typeof searchTerm !== "undefined" ? searchTerm : "",
      currentRoute: typeof currentRoute !== "undefined" ? currentRoute : "/"
    }) %>
  <% } %>
</div>

</section>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
